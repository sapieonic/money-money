service: money-tracker-api

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-south-1'}
  environment:
    MONGODB_URI: ${env:MONGODB_URI}
    MONGODB_DB_NAME: ${env:MONGODB_DB_NAME, 'money-tracker-dev'}
    FIREBASE_PROJECT_ID: ${env:FIREBASE_PROJECT_ID}
    TELEGRAM_BOT_TOKEN: ${env:TELEGRAM_BOT_TOKEN, ''}
    # LLM Provider Configuration (optional)
    LLM_PROVIDER: ${env:LLM_PROVIDER, ''}
    # Azure OpenAI Configuration
    AZURE_OPENAI_API_KEY: ${env:AZURE_OPENAI_API_KEY, ''}
    AZURE_OPENAI_ENDPOINT: ${env:AZURE_OPENAI_ENDPOINT, ''}
    AZURE_OPENAI_DEPLOYMENT: ${env:AZURE_OPENAI_DEPLOYMENT, ''}
    AZURE_OPENAI_API_VERSION: ${env:AZURE_OPENAI_API_VERSION, '2024-02-15-preview'}
    # Email Configuration (Mailjet)
    EMAIL_PROVIDER: ${env:EMAIL_PROVIDER, ''}
    MAILJET_API_KEY: ${env:MAILJET_API_KEY, ''}
    MAILJET_SECRET_KEY: ${env:MAILJET_SECRET_KEY, ''}
    MAILJET_FROM_EMAIL: ${env:MAILJET_FROM_EMAIL, ''}
    MAILJET_FROM_NAME: ${env:MAILJET_FROM_NAME, 'Finance Watch'}
    # OpenTelemetry Configuration (Grafana Cloud)
    # These are used by our custom telemetry utility
    OTEL_SERVICE_NAME: finance-watch-api
    OTEL_EXPORTER_OTLP_ENDPOINT: ${env:GRAFANA_OTLP_ENDPOINT, ''}
    OTEL_EXPORTER_OTLP_HEADERS: ${env:GRAFANA_OTLP_HEADERS, ''}
    OTEL_RESOURCE_ATTRIBUTES: deployment.environment=${self:provider.stage}
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:5173
        - http://localhost:3000
        - https://money.manasranjan.dev
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS

build:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - aws-sdk
    target: node20
    platform: node

plugins:
  - serverless-offline

functions:
  # Income endpoints
  getIncomes:
    handler: src/handlers/income.getAll
    events:
      - httpApi:
          path: /api/income
          method: get

  createIncome:
    handler: src/handlers/income.create
    events:
      - httpApi:
          path: /api/income
          method: post

  updateIncome:
    handler: src/handlers/income.update
    events:
      - httpApi:
          path: /api/income/{id}
          method: put

  deleteIncome:
    handler: src/handlers/income.remove
    events:
      - httpApi:
          path: /api/income/{id}
          method: delete

  # Expense endpoints
  getExpenses:
    handler: src/handlers/expenses.getAll
    events:
      - httpApi:
          path: /api/expenses
          method: get

  createExpense:
    handler: src/handlers/expenses.create
    events:
      - httpApi:
          path: /api/expenses
          method: post

  updateExpense:
    handler: src/handlers/expenses.update
    events:
      - httpApi:
          path: /api/expenses/{id}
          method: put

  deleteExpense:
    handler: src/handlers/expenses.remove
    events:
      - httpApi:
          path: /api/expenses/{id}
          method: delete

  # Daily Expense endpoints
  getDailyExpenses:
    handler: src/handlers/dailyExpenses.getAll
    events:
      - httpApi:
          path: /api/daily-expenses
          method: get

  getDailyExpensesSummary:
    handler: src/handlers/dailyExpenses.getSummary
    events:
      - httpApi:
          path: /api/daily-expenses/summary
          method: get

  createDailyExpense:
    handler: src/handlers/dailyExpenses.create
    events:
      - httpApi:
          path: /api/daily-expenses
          method: post

  updateDailyExpense:
    handler: src/handlers/dailyExpenses.update
    events:
      - httpApi:
          path: /api/daily-expenses/{id}
          method: put

  deleteDailyExpense:
    handler: src/handlers/dailyExpenses.remove
    events:
      - httpApi:
          path: /api/daily-expenses/{id}
          method: delete

  getWeeklyAnalytics:
    handler: src/handlers/dailyExpenses.getWeeklyAnalytics
    events:
      - httpApi:
          path: /api/daily-expenses/weekly-analytics
          method: get

  sendWeeklySummaryEmail:
    handler: src/handlers/dailyExpenses.sendWeeklySummaryEmail
    events:
      - httpApi:
          path: /api/daily-expenses/send-weekly-summary
          method: post

  # Investment endpoints
  getInvestments:
    handler: src/handlers/investments.getAll
    events:
      - httpApi:
          path: /api/investments
          method: get

  createInvestment:
    handler: src/handlers/investments.create
    events:
      - httpApi:
          path: /api/investments
          method: post

  updateInvestment:
    handler: src/handlers/investments.update
    events:
      - httpApi:
          path: /api/investments/{id}
          method: put

  toggleInvestmentStatus:
    handler: src/handlers/investments.toggleStatus
    events:
      - httpApi:
          path: /api/investments/{id}/status
          method: patch

  deleteInvestment:
    handler: src/handlers/investments.remove
    events:
      - httpApi:
          path: /api/investments/{id}
          method: delete

  # Asset endpoints
  getAssets:
    handler: src/handlers/assets.getAll
    events:
      - httpApi:
          path: /api/assets
          method: get

  createAsset:
    handler: src/handlers/assets.create
    events:
      - httpApi:
          path: /api/assets
          method: post

  updateAsset:
    handler: src/handlers/assets.update
    events:
      - httpApi:
          path: /api/assets/{id}
          method: put

  updateAssetValue:
    handler: src/handlers/assets.updateValue
    events:
      - httpApi:
          path: /api/assets/{id}/value
          method: patch

  deleteAsset:
    handler: src/handlers/assets.remove
    events:
      - httpApi:
          path: /api/assets/{id}
          method: delete

  # Dashboard & Settings
  getDashboard:
    handler: src/handlers/dashboard.get
    events:
      - httpApi:
          path: /api/dashboard
          method: get

  getSnapshots:
    handler: src/handlers/dashboard.getSnapshots
    events:
      - httpApi:
          path: /api/snapshots
          method: get

  getSettings:
    handler: src/handlers/settings.get
    events:
      - httpApi:
          path: /api/settings
          method: get

  updateSettings:
    handler: src/handlers/settings.update
    events:
      - httpApi:
          path: /api/settings
          method: put

  # Telegram Integration endpoints
  telegramWebhook:
    handler: src/handlers/telegram.webhook
    events:
      - httpApi:
          path: /api/telegram/webhook
          method: post

  telegramStatus:
    handler: src/handlers/telegram.status
    events:
      - httpApi:
          path: /api/telegram/status
          method: get

  telegramVerifyCode:
    handler: src/handlers/telegram.verifyCode
    events:
      - httpApi:
          path: /api/telegram/verify-code
          method: post

  telegramUnlink:
    handler: src/handlers/telegram.unlink
    events:
      - httpApi:
          path: /api/telegram/unlink
          method: delete

  # Scheduled Jobs
  weeklyExpenseSummary:
    handler: src/handlers/scheduledJobs.sendWeeklyExpenseSummaries
    timeout: 60
    events:
      - schedule:
          rate: cron(30 3 ? * MON *)  # Every Monday at 9:00 AM IST (3:30 UTC)
          enabled: true
          description: Send weekly expense summary emails
